# 実装ガイドライン

> Implementation Guidelines - 実装方針とコーディング規約

最終更新: 2026年2月21日

---

## 📋 概要

### 目的

このドキュメントは、guild-mng-bot-v2 における実装時の設計方針、責務分離ルール、コメント規約、リファクタリング手順を定義します。機能追加・改修時に「どこへ何を書くか」を明確化し、レビューコストと将来の保守コストを下げることを目的とします。

### 対象読者

- プロジェクトの開発者
- コードレビュー担当者
- 新規参加者

### このドキュメントのスコープ

- 扱う内容: 実装時の分割方針、ファイル配置、命名/コメント規約、実装手順
- 扱わない内容: システム全体図、プロセス間関係、レイヤ境界の背景説明
- 全体設計は [ARCHITECTURE.md](ARCHITECTURE.md) を参照

### ドキュメント整合ルール

- `ARCHITECTURE.md` は「構成と責務境界」を記述する
- 本ガイドは「実装手順と実装規約」を記述する
- 同じテーマが重なる場合は、方針は `ARCHITECTURE.md`、実装詳細は本ガイドに寄せる

---

## 🎯 実装方針

### 基本方針

1. **責務分離を優先する**
   - `commands` はコマンド定義と入口処理に限定
   - 業務ロジックは `features` に配置
   - 共通ロジックは `shared` に配置

2. **既存仕様を壊さない**
   - 権限仕様、翻訳キー、レスポンス仕様は原則維持
   - リファクタでは挙動変更を含めない

3. **小さく安全に変更する**
   - 1PR 1目的を原則とする
   - 巨大ファイルは段階分割（定数→ルーター→サブ機能）で進める

4. **型安全を維持する**
   - `any` の導入は避ける
   - `pnpm run typecheck` を必ず通す

---

## 🏗️ レイヤ構成ルール

### `src/bot/commands`

- 許可:
  - SlashCommandBuilder の定義
  - options の受け取り
  - feature 層への委譲
  - 最終的な `execute` 入口
- 非推奨:
  - DB更新
  - 複雑な分岐ロジック
  - コンポーネント collector 制御
  - 長い業務処理

### `src/bot/features`

- 許可:
  - ユースケース実装
  - ルール判定
  - 状態更新
  - UI操作（必要な場合）
- 推奨構成:
  - `commands/`（コマンド別の実行処理）
  - `handlers/`（イベント境界）
  - `handlers/ui/`（Button/Select/Modal などUI境界）
  - `services/`（機能サービス）
  - `repositories/`（永続化アクセス）
  - `constants/`（定数・型ガード・変換ヘルパー）

### `src/shared`

- Bot/Web 両方で再利用する実装のみ配置
- `shared` から `bot` / `web` へ逆依存しない

### feature ディレクトリ標準テンプレート

```text
src/bot/features/<feature-name>/
├── index.ts
├── commands/
│   └── index.ts
├── handlers/
│   ├── ui/
│   │   └── index.ts
│   └── index.ts
├── services/
│   └── index.ts
├── repositories/
│   └── index.ts
└── constants/
   └── index.ts
```

### `index.ts`（バレル）実装ルール

- 外部層（`events/`, `commands/`, `handlers`レジストリ等）からは、feature直下またはサブディレクトリの `index.ts` 経由で import する
- feature 内部は相対 import を許可する（バレル強制で循環参照を増やさない）
- `index.ts` は再エクスポート専用にし、実ロジックを持たせない
- 再エクスポート対象は「公開APIとして維持するシンボル」のみに限定する

---

## 📝 コメント規約

実装コードの可読性とレビュー効率を揃えるため、以下を必須とします。

### 1. ファイル先頭コメント

- 必須: ファイル先頭で「何のファイルか」を明記する
- 例:

```ts
// src/bot/features/foo/fooService.ts
// Foo機能の業務ロジックを担当するサービス
```

### 2. 関数コメント

- 必須: すべての関数の先頭に「何をする関数か」を記載
- 必須: `@param` と `@returns` を記載
- 例:

```ts
/**
 * ギルド設定を取得する
 * @param guildId 取得対象のギルドID
 * @returns ギルド設定（未設定時は null）
 */
```

### 3. 変数・定数コメント

- ローカル変数/ローカル定数: 原則コメント不要
- ファイル内/外で共用する変数・定数: 何の値かを記載
  - 例: コマンド名定数、CustomId接頭辞、制限値

### 4. 処理ブロックコメント

- 必須: 分岐・副作用・外部連携の手前に「処理の意図」を記載
- 推奨: 1〜2行で簡潔に書く
- 禁止: 逐語的で自明な説明

---

## 🔁 リファクタリング手順（推奨）

1. **定数切り出し**
   - コマンド名・選択値・共用IDを `*.constants.ts` に集約

2. **ルーター化**
   - `*.execute.ts` を入口専用にし、サブコマンドで分岐のみ行う

3. **処理分割**
   - サブコマンドごとに `*.enable.ts` / `*.disable.ts` のように分割

4. **共通ガード抽出**
   - 権限チェック等を `*.guard.ts` に集約

5. **検証**
   - `pnpm run typecheck`
   - 必要に応じて `pnpm test`

### src整備フェーズ運用順序

src整備スプリントでは、次の順序を固定する。

1. **再分析**
   - `typecheck` / `lint` を通し、責務境界・依存方向・公開面の逸脱がないことを確認する
2. **コメント規約反映**
   - `src/` 全体へファイル先頭コメント・関数コメント・意図コメントを適用する
3. **ドキュメント同期**
   - `ARCHITECTURE.md` と `IMPLEMENTATION_GUIDELINES.md` を実装実態へ合わせる
4. **TODO同期**
   - 完了条件と次フェーズの順序を TODO へ反映する
5. **テスト修正フェーズ移行**
   - 上記 1〜4 の完了後にのみ `pnpm test` 系を再開する

---

## ✅ 実装チェックリスト

- [ ] 変更責務は適切なレイヤに配置されている
- [ ] `commands` に業務ロジックが残っていない
- [ ] ファイル先頭コメントがある
- [ ] 全関数に `@param` / `@returns` がある
- [ ] 共用定数に説明コメントがある
- [ ] 処理ブロックの意図コメントがある
- [ ] `typecheck` が通る
- [ ] （src整備時）再分析 → コメント反映 → ドキュメント同期 → TODO同期の順序を守っている

---

## 🔗 関連ドキュメント

- [ARCHITECTURE.md](ARCHITECTURE.md)
- [DEVELOPMENT_SETUP.md](DEVELOPMENT_SETUP.md)
- [TESTING_GUIDELINES.md](TESTING_GUIDELINES.md)
