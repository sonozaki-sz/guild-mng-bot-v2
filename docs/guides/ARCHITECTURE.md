# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰

> Architecture Guide - ã‚³ãƒ¼ãƒ‰è¨­è¨ˆãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆãƒ»è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®è§£èª¬

æœ€çµ‚æ›´æ–°: 2026å¹´2æœˆ28æ—¥

---

## ğŸ“‹ æ¦‚è¦

ayasono ã¯ **Bot ãƒ—ãƒ­ã‚»ã‚¹**ã¨ **Web ãƒ—ãƒ­ã‚»ã‚¹**ã®2ãƒ—ãƒ­ã‚»ã‚¹æ§‹æˆã§å‹•ä½œã—ã¾ã™ã€‚
ãã‚Œãã‚Œç‹¬ç«‹ã—ã¦èµ·å‹•ãƒ»åœæ­¢ã§ãã€å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆ`src/shared/`ï¼‰ã‚’é€šã˜ã¦ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ã—ã¾ã™ã€‚

### ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚³ãƒ¼ãƒ—

- æ‰±ã†å†…å®¹: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ§‹æˆã€ä¾å­˜æ–¹å‘ã€ãƒ¬ã‚¤ãƒ¤å¢ƒç•Œã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è²¬å‹™
- æ‰±ã‚ãªã„å†…å®¹: é–¢æ•°åˆ†å‰²æ‰‹é †ã€å‘½å/ã‚³ãƒ¡ãƒ³ãƒˆç´°å‰‡ã€å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- å®Ÿè£…ç´°å‰‡ã¯ [IMPLEMENTATION_GUIDELINES.md](IMPLEMENTATION_GUIDELINES.md) ã‚’å‚ç…§

### 0ãƒ™ãƒ¼ã‚¹å†ç›£æŸ»çµæœï¼ˆ2026-02-22ï¼‰

- è²¬å‹™åˆ†é›¢:
  - `commands/*.execute.ts` ã®å…¥å£ã¯æ¦‚ã­ã€Œå…¥åŠ›è§£é‡ˆãƒ»å§”è­²ãƒ»å…±é€šã‚¨ãƒ©ãƒ¼å‡¦ç†ã€ã«åæŸ
  - ãŸã ã— `bumpReminderConfigCommand.removeMention.ts` ã¯ 300 è¡Œç´šã§ã€è¿½åŠ åˆ†å‰²ä½™åœ°ã‚ã‚Š
- ä¾å­˜æ–¹å‘:
  - `shared -> bot/web` ã¨ `bot <-> web` ã®ç›´æ¥ä¾å­˜ã¯ç›£æŸ»æ™‚ç‚¹ã§æ¤œå‡ºãªã—
  - ä¾å­˜æ–¹å‘ã¯ `bot|web -> shared` ã®åŸå‰‡ã‚’ç¶­æŒ
- æ§‹æˆ/å…¬é–‹é¢:
  - æ—§ `index.ts` barrel ã¯æ’¤å»ƒã—ã€æ˜ç¤ºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åï¼ˆä¾‹: `commands.ts`ï¼‰ã¸çµ±ä¸€æ¸ˆã¿
  - æ–¹é‡ã‚’ã€Œå…¬é–‹å¢ƒç•Œãƒ»å†…éƒ¨å±¤ã¨ã‚‚ã«ç›´æ¥ importã€ã«çµ±ä¸€
  - `shared/database` ã¯å‹/å®Ÿè£…ã‚’ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã§ç›´æ¥å‚ç…§ã™ã‚‹
- å‘½å:
  - `stick` ã¨ `sticky` ã¯ç§»è¡Œé€”ä¸­ã§æ··åœ¨ï¼ˆäº’æ›ç¶­æŒã®ãŸã‚æ®µéšç§»è¡Œã‚’ç¶™ç¶šï¼‰
- ã‚¹ãƒªãƒ åŒ–:
  - `src` å…¨175ãƒ•ã‚¡ã‚¤ãƒ«ä¸­ã€300è¡Œè¶…ã¯3ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§åœ§ç¸®æ¸ˆã¿
  - å¼•ãç¶šãå¤§å‹ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ä½™åœ°ã‚’ç®¡ç†ã™ã‚‹
- ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§:
  - Composition Root + resolveræ³¨å…¥ã«ã‚ˆã‚Šã€ä¾å­˜åˆ‡æ›¿ã®çµŒè·¯ã¯ç¢ºä¿
  - importå¤‰æ›´æ™‚ã¯ãƒ¢ãƒƒã‚¯å¯¾è±¡ãƒ‘ã‚¹è¿½å¾“ãŒå¿…é ˆï¼ˆå†…éƒ¨å®Ÿè£…ã¯å®Ÿè§£æ±ºå…ˆã‚’ãƒ¢ãƒƒã‚¯ï¼‰

---

## ğŸ—ï¸ ãƒ—ãƒ­ã‚»ã‚¹æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ayasono                                                â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Bot ãƒ—ãƒ­ã‚»ã‚¹      â”‚    â”‚  Web ãƒ—ãƒ­ã‚»ã‚¹             â”‚   â”‚
â”‚  â”‚  src/bot/main.ts â”‚    â”‚  src/web/server.ts       â”‚   â”‚
â”‚  â”‚                  â”‚    â”‚                          â”‚   â”‚
â”‚  â”‚  Discord Bot     â”‚    â”‚  Fastify HTTP Server     â”‚   â”‚
â”‚  â”‚  Gateway æ¥ç¶š     â”‚    â”‚  REST API + é™çš„é…ä¿¡      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                          â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                      â–¼                                  â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚             â”‚  src/shared/     â”‚                        â”‚
â”‚             â”‚  å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯      â”‚                        â”‚
â”‚             â”‚  DB / i18n / etc â”‚                        â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â”‚                                  â”‚
â”‚                      â–¼                                  â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚             â”‚  SQLite (libSQL)   â”‚                      â”‚
â”‚             â”‚  storage/db.sqlite â”‚                      â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èµ·å‹•ã‚³ãƒãƒ³ãƒ‰**:

```bash
# ä¸¡æ–¹åŒæ™‚èµ·å‹•ï¼ˆé–‹ç™ºï¼‰
pnpm dev

# å€‹åˆ¥èµ·å‹•
pnpm dev:bot   # Bot ã®ã¿
pnpm dev:web   # Web ã®ã¿

# æœ¬ç•ª
pnpm start     # ä¸¡æ–¹
```

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
src/
â”œâ”€â”€ bot/                   # Bot ãƒ—ãƒ­ã‚»ã‚¹å°‚ç”¨
â”‚   â”œâ”€â”€ main.ts            # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ client.ts          # BotClient ã‚¯ãƒ©ã‚¹ï¼ˆdiscord.js Client æ‹¡å¼µï¼‰
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ discord.ts     # Botå°‚ç”¨ã®discord.jså‹æ‹¡å¼µ
â”‚   â”œâ”€â”€ commands/          # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…
â”‚   â”œâ”€â”€ events/            # Discord ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
â”‚   â”œâ”€â”€ features/          # Botå°‚ç”¨æ©Ÿèƒ½ï¼ˆbump-reminder, vac ãªã©ï¼‰
â”‚   â”œâ”€â”€ handlers/interactionCreate/
â”‚   â”‚   â”œâ”€â”€ flow/          # command/components/modal ã®ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
â”‚   â”‚   â”œâ”€â”€ handleInteractionCreate.ts # interactionCreate å…¥å£
â”‚   â”‚   â””â”€â”€ ui/            # UIã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¬ã‚¸ã‚¹ãƒˆãƒª
â”‚   â”œâ”€â”€ errors/
â”‚   â”‚   â””â”€â”€ interactionErrorHandler.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ interaction.ts
â”‚   â”‚   â””â”€â”€ messageResponse.ts
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ cooldownManager.ts
â”‚       â””â”€â”€ botEventRegistration.ts
â”‚
â”œâ”€â”€ shared/                # Botãƒ»Web ä¸¡ãƒ—ãƒ­ã‚»ã‚¹ã§ä½¿ç”¨ã™ã‚‹å…±æœ‰ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ env.ts         # ç’°å¢ƒå¤‰æ•°å®šç¾©ï¼ˆZod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ types.ts       # ãƒ‰ãƒ¡ã‚¤ãƒ³å‹å®šç¾©ï¼ˆGuildConfig, AfkConfig ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ guildConfigRepositoryProvider.ts # Repositoryæä¾›ï¼ˆå†…éƒ¨å®Ÿè£…ï¼‰
â”‚   â”‚   â”œâ”€â”€ repositories/  # DB ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆRepository ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
â”‚   â”‚   â””â”€â”€ stores/        # æ©Ÿèƒ½åˆ¥ã®æ°¸ç¶šåŒ–ã‚¹ãƒˆã‚¢
â”‚   â”œâ”€â”€ errors/
â”‚   â”‚   â”œâ”€â”€ customErrors.ts
â”‚   â”‚   â”œâ”€â”€ errorUtils.ts
â”‚   â”‚   â””â”€â”€ processErrorHandler.ts
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ vac/           # å…±æœ‰å¯èƒ½ãªVACè¨­å®šã‚µãƒ¼ãƒ“ã‚¹ï¼ˆRepositoryä¾å­˜ï¼‰
â”‚   â”‚   â””â”€â”€ bump-reminder/ # å…±æœ‰å¯èƒ½ãªBumpè¨­å®šã‚µãƒ¼ãƒ“ã‚¹ï¼ˆRepositoryä¾å­˜ï¼‰
â”‚   â”œâ”€â”€ locale/            # i18nï¼ˆi18nextï¼‰
â”‚   â”œâ”€â”€ scheduler/
â”‚   â”‚   â””â”€â”€ jobScheduler.ts
â”‚   â”œâ”€â”€ types/
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ logger.ts
â”‚       â””â”€â”€ prisma.ts
â”‚
â””â”€â”€ web/                   # Web ãƒ—ãƒ­ã‚»ã‚¹å°‚ç”¨
    â”œâ”€â”€ server.ts          # Fastify ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    â”œâ”€â”€ webAppBuilder.ts   # Webã‚¢ãƒ—ãƒªçµ„ã¿ç«‹ã¦
    â”œâ”€â”€ middleware/
    â”‚   â””â”€â”€ auth.ts        # Bearer ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼
    â”œâ”€â”€ routes/
    â”‚   â”œâ”€â”€ health.ts      # GET /health, GET /ready
    â”‚   â””â”€â”€ api/           # GET /api/*
    â”œâ”€â”€ schemas/           # ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
    â””â”€â”€ public/            # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡
```

### è¨­è¨ˆåŸå‰‡

| ãƒ«ãƒ¼ãƒ«                                                          | ç†ç”±                                 |
| --------------------------------------------------------------- | ------------------------------------ |
| `src/bot/` â†’ `src/shared/` ã¸ã®ä¾å­˜ã®ã¿è¨±å¯                     | Bot ã¨ Web ã®ç–çµåˆã‚’ç¶­æŒ            |
| `src/web/` â†’ `src/shared/` ã¸ã®ä¾å­˜ã®ã¿è¨±å¯                     | åŒä¸Š                                 |
| `src/shared/` ã¯ Botãƒ»Web ã©ã¡ã‚‰ã«ã‚‚ä¾å­˜ã—ãªã„                  | å…±æœ‰ã‚³ãƒ¼ãƒ‰ã®ç‹¬ç«‹æ€§ã‚’ä¿è¨¼             |
| å…±æœ‰å¯èƒ½ãªæ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ã¯ `src/shared/features/<æ©Ÿèƒ½å>/` ã«é…ç½® | Bot/Web ã§ã®å†åˆ©ç”¨æ€§ã‚’ç¶­æŒ           |
| Botå°‚ç”¨æ©Ÿèƒ½ã¯ `src/bot/features/<æ©Ÿèƒ½å>/` ã«é…ç½®               | Discordä¾å­˜ãƒ»Botå°‚ç”¨è²¬å‹™ã®æ··åœ¨ã‚’é˜²æ­¢ |

### srcæ•´å‚™ãƒ•ã‚§ãƒ¼ã‚ºã®é‹ç”¨å¢ƒç•Œ

- srcæ•´å‚™ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€å®Ÿè£…æ•´ç†ã®å®Œäº†åˆ¤å®šã‚’å„ªå…ˆã—ã€ãƒ†ã‚¹ãƒˆä¿®æ­£ãƒ•ã‚§ãƒ¼ã‚ºã¯åˆ†é›¢ã™ã‚‹
- é †åºã¯ **å†åˆ†æ â†’ ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´„åæ˜  â†’ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒæœŸ â†’ TODOåŒæœŸ â†’ ãƒ†ã‚¹ãƒˆä¿®æ­£** ã‚’åŸå‰‡ã¨ã™ã‚‹
- ã“ã®é †åºã«ã‚ˆã‚Šã€æ§‹é€ å¤‰æ›´ã¨ãƒ†ã‚¹ãƒˆè¿½éšã‚’åŒä¸€ãƒ•ã‚§ãƒ¼ã‚ºã§æ··åœ¨ã•ã›ãšã€å·®åˆ†ã®è²¬å‹™ã‚’æ˜ç¢ºåŒ–ã™ã‚‹

### æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‘½åè¦ç´„

- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯å½¹å‰²åãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: `commands.ts`, `events.ts`, `apiRoutes.ts`, `handleInteractionCreate.ts`, `resources.ts`ï¼‰ã«çµ±ä¸€ã™ã‚‹
- æ©Ÿèƒ½ã‚µãƒ¼ãƒ“ã‚¹ã¯ `*Service.ts`ï¼ˆä¾‹: `VacConfigService.ts`, `BumpReminderService.ts`ï¼‰
- æ©Ÿèƒ½å®šæ•°ã¯ `*Constants.ts`ï¼ˆä¾‹: `BumpReminderConstants.ts`ï¼‰
- æ©Ÿèƒ½Repositoryã¯ `*Repository.ts`ï¼ˆä¾‹: `BumpReminderRepository.ts`ï¼‰
- äº’æ›ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ®‹ã•ãšå»ƒæ­¢ã—ã€å‚ç…§å…ˆã¯å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¸çµ±ä¸€ã™ã‚‹

### Bot feature ã®æ¨™æº–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

Bot å°‚ç”¨æ©Ÿèƒ½ï¼ˆ`src/bot/features/<feature-name>/`ï¼‰ã¯ã€ä»¥ä¸‹ã®æ§‹æˆã‚’æ¨™æº–ã¨ã—ã¾ã™ã€‚

```
src/bot/features/<feature-name>/
â”œâ”€â”€ commands/             # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå‡¦ç†ï¼ˆä¾‹: `vacCommand.execute.ts`ï¼‰
â”œâ”€â”€ handlers/             # ã‚¤ãƒ™ãƒ³ãƒˆå¢ƒç•Œãƒ»èµ·å‹•å‡¦ç†
â”‚   â””â”€â”€ ui/               # Button/Select/Modal ãªã©UIå¢ƒç•Œ
â”œâ”€â”€ services/             # æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ repositories/         # æ°¸ç¶šåŒ–ã‚¢ã‚¯ã‚»ã‚¹
â””â”€â”€ constants/            # å…±é€šå®šæ•°ãƒ»å‹ã‚¬ãƒ¼ãƒ‰ãƒ»å¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼
```

è©³ç´°ãªå®Ÿè£…é‹ç”¨ï¼ˆç›´æ¥importè¦ç´„ã€å…¬é–‹APIã®çµã‚Šæ–¹ï¼‰ã¯
[IMPLEMENTATION_GUIDELINES.md](IMPLEMENTATION_GUIDELINES.md) ã®ã€Œ`index.ts`ï¼ˆãƒãƒ¬ãƒ«ï¼‰ç¦æ­¢ãƒ«ãƒ¼ãƒ«ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### import å¢ƒç•Œãƒ«ãƒ¼ãƒ«ï¼ˆé‹ç”¨ï¼‰

- å…¬é–‹å¢ƒç•Œãƒ»å†…éƒ¨å®Ÿè£…ã‚’å•ã‚ãšã€`index.ts` çµŒç”± import ã¯åˆ©ç”¨ã—ãªã„
- import ã¯å¸¸ã«å®Ÿä½“ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå½¹å‰²åãƒ•ã‚¡ã‚¤ãƒ«/å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ç›´æ¥å‚ç…§ã™ã‚‹
- ã“ã®æ–¹é‡ã«ã‚ˆã‚Šã€å¾ªç’°ä¾å­˜ãƒªã‚¹ã‚¯ã¨ãƒ¢ãƒƒã‚¯è¿½å¾“ã‚³ã‚¹ãƒˆã‚’æŠ‘åˆ¶ã™ã‚‹

---

## ğŸ¤– Discord Bot è¨­è¨ˆ

### Gateway Intents

```typescript
// src/bot/client.ts
intents: [
  GatewayIntentBits.Guilds, // ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ãƒ»ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±
  GatewayIntentBits.MessageContent, // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®èª­ã¿å–ã‚Šï¼ˆBumpæ¤œçŸ¥ã«å¿…é ˆï¼‰
  GatewayIntentBits.GuildMessages, // ã‚µãƒ¼ãƒãƒ¼å†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆ
  GatewayIntentBits.GuildMembers, // ãƒ¡ãƒ³ãƒãƒ¼å‚åŠ ãƒ»é€€å‡ºã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå°†æ¥ã® MemberLog ç”¨ï¼‰
  GatewayIntentBits.GuildVoiceStates, // VC å‚åŠ ãƒ»é€€å‡ºã‚¤ãƒ™ãƒ³ãƒˆï¼ˆAFKç§»å‹•ãƒ»å°†æ¥ã® VAC ç”¨ï¼‰
];
```

> **æ³¨æ„**: `MessageContent` ã¨ `GuildMembers` ã¯ Discord Developer Portal ã§ã® **Privileged Intents æœ‰åŠ¹åŒ–**ãŒå¿…è¦ã§ã™ã€‚

### BotClient ã‚¯ãƒ©ã‚¹

`discord.js` ã® `Client` ã‚’æ‹¡å¼µã—ã€ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ï¼š

```typescript
class BotClient extends Client {
  commands: Collection<string, Command>; // ç™»éŒ²æ¸ˆã¿ã‚³ãƒãƒ³ãƒ‰
  modals: Collection<string, Modal>; // ç™»éŒ²æ¸ˆã¿ãƒ¢ãƒ¼ãƒ€ãƒ«
  cooldownManager: CooldownManager; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†
}
```

### ã‚³ãƒãƒ³ãƒ‰ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```typescript
interface Command {
  data: SharedSlashCommand;
  execute: (interaction: ChatInputCommandInteraction) => Promise<void>;
  autocomplete?: (interaction: AutocompleteInteraction) => Promise<void>;
  cooldown?: number; // ç§’å˜ä½ï¼ˆçœç•¥æ™‚ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãªã—ï¼‰
}

interface Modal {
  modal: ModalBuilder;
  data?: unknown;
  execute: (interaction: ModalSubmitInteraction) => Promise<void>;
}
```

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### æ¥ç¶šç®¡ç†

`setPrismaClient()` / `getPrismaClient()` / `requirePrismaClient()` ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ç®¡ç†ã—ã¾ã™ã€‚
`global` å¤‰æ•°ã‚’ä½¿ã‚ãšã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã®å¤‰æ•°ã§ Prisma Client ã‚’ä¿æŒã—ã¾ã™ã€‚

```typescript
// èµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘ç™»éŒ²
setPrismaClient(prisma);

// åˆ©ç”¨å´ï¼ˆå¿…ãšå­˜åœ¨ã™ã‚‹å‰æï¼‰
const prisma = requirePrismaClient(); // å­˜åœ¨ã—ãªã„å ´åˆã¯ Error ã‚’ã‚¹ãƒ­ãƒ¼

// åˆ©ç”¨å´ï¼ˆå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ã‚ã‚Šï¼‰
const prisma = getPrismaClient(); // null ã®å ´åˆã‚ã‚Š
```

### Repository ãƒ‘ã‚¿ãƒ¼ãƒ³

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã™ã¹ã¦ Repository ã‚¯ãƒ©ã‚¹ã‚’çµŒç”±ã—ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆæ™‚ã¯ Repository ã‚’ãƒ¢ãƒƒã‚¯æ³¨å…¥ã™ã‚‹ã“ã¨ã§ DB ä¾å­˜ã‚’æ’é™¤ã§ãã¾ã™ã€‚

```
GuildConfigRepository   â† ã‚®ãƒ«ãƒ‰å…¨èˆ¬è¨­å®šï¼ˆlocale, afkConfig, bumpReminderConfig, vacConfig ç­‰ï¼‰
GuildBumpReminderConfigStore â† BumpReminderConfig ã®è©³ç´°ãª read/write æ“ä½œ
BumpReminderRepository  â† BumpReminder ãƒ†ãƒ¼ãƒ–ãƒ«ã® CRUDï¼ˆfeatures/bump-reminder/ï¼‰
```

### è¨­å®šãƒ‡ãƒ¼ã‚¿ã® JSON ä¿å­˜

æ©Ÿèƒ½è¨­å®šï¼ˆAfkConfig, BumpReminderConfig ç­‰ï¼‰ã¯ `GuildConfig` ãƒ†ãƒ¼ãƒ–ãƒ«ã« **JSON æ–‡å­—åˆ—**ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
ã“ã‚Œã¯ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãªã—ã«è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã§ãã‚‹åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

```typescript
// DB ã«ä¿å­˜ã™ã‚‹ã¨ã
data.afkConfig = JSON.stringify(afkConfig);

// DB ã‹ã‚‰èª­ã¿å‡ºã™ã¨ã
const afkConfig = safeJsonParse<AfkConfig>(record.afkConfig);
```

**å„è¨­å®šã®å‹**:

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å         | å‹                   | ç”¨é€”                                                            |
| -------------------- | -------------------- | --------------------------------------------------------------- |
| `afkConfig`          | `AfkConfig`          | enabled ãƒ•ãƒ©ã‚° + AFKãƒãƒ£ãƒ³ãƒãƒ«ID                                |
| `bumpReminderConfig` | `BumpReminderConfig` | Bumpé€šçŸ¥ã® enabled + mentionè¨­å®š                                |
| `vacConfig`          | `VacConfig`          | VCè‡ªå‹•ä½œæˆè¨­å®š                                                  |
| `memberLogConfig`    | `MemberLogConfig`    | ãƒ¡ãƒ³ãƒãƒ¼ãƒ­ã‚°è¨­å®šï¼ˆæœªå®Ÿè£…ï¼‰                                      |
| `stickMessages`      | `StickMessage[]`     | å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ï¼ˆå°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« `sticky_messages` ã«ç§»è¡Œæ¸ˆã¿ï¼‰ |

---

## â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼è¨­è¨ˆ

`JobScheduler` ã¯2ç¨®é¡ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

| ç¨®åˆ¥           | ãƒ¡ã‚½ãƒƒãƒ‰          | ä»•çµ„ã¿                  | ç”¨é€”                |
| -------------- | ----------------- | ----------------------- | ------------------- |
| ç¹°ã‚Šè¿”ã—ã‚¸ãƒ§ãƒ– | `addJob()`        | node-cron               | å®šæœŸå®Ÿè¡Œã‚¿ã‚¹ã‚¯      |
| 1å›é™ã‚Šã‚¸ãƒ§ãƒ–  | `addOneTimeJob()` | setTimeout + `.unref()` | Bump ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç­‰ |

`setTimeout` ã« `.unref()` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŸã‚ã€**ã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ã„ã¦ã‚‚ Node.js ãƒ—ãƒ­ã‚»ã‚¹ã¯æ­£å¸¸çµ‚äº†**ã§ãã¾ã™ã€‚

`BumpReminderManager` ã¯ `JobScheduler` ã‚’ãƒ©ãƒƒãƒ—ã—ã€ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã® DB æ°¸ç¶šåŒ–ã¨å†èµ·å‹•æ™‚ã®å¾©å…ƒã‚’æ‹…ã„ã¾ã™ã€‚

```
Bot èµ·å‹•
  â””â”€ clientReady ã‚¤ãƒ™ãƒ³ãƒˆ
       â””â”€ BumpReminderManager.restorePendingReminders()
            â”œâ”€ DB ã‹ã‚‰ status=pending ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—
            â”œâ”€ scheduledAt ãŒéå» â†’ å³æ™‚å®Ÿè¡Œ
            â””â”€ scheduledAt ãŒæœªæ¥ â†’ setTimeout ã§å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
```

---

## ğŸŒ Web API è¨­è¨ˆ

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹      | èªè¨¼   | èª¬æ˜                              |
| -------- | --------- | ------ | --------------------------------- |
| `GET`    | `/health` | ãªã—   | ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒç¢ºèª                  |
| `GET`    | `/ready`  | ãªã—   | DB æ¥ç¶šç¢ºèªï¼ˆèµ·å‹•å®Œäº†ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰ |
| `GET`    | `/api/*`  | Bearer | API ãƒ«ãƒ¼ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰              |

### `/health` ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

```json
{
  "status": "ok",
  "timestamp": "2026-02-19T10:00:00.000Z",
  "uptime": 3600.5
}
```

### `/ready` ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

```json
// DB æ¥ç¶šOK (200)
{ "ready": true }

// DB æœªæ¥ç¶š (503)
{ "ready": false, "reason": "Database not initialized" }
```

`/ready` ã¯ Kubernetes ã® readiness probe ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®èµ·å‹•å¾…ã¡ç¢ºèªã«ä½¿ãˆã¾ã™ã€‚

### èªè¨¼

`Authorization: Bearer <JWT_SECRET>` ãƒ˜ãƒƒãƒ€ãƒ¼ã§èªè¨¼ã—ã¾ã™ã€‚

- `JWT_SECRET` ç’°å¢ƒå¤‰æ•°ãŒ**æœªè¨­å®šã®å ´åˆã¯èªè¨¼ã‚¹ã‚­ãƒƒãƒ—**ï¼ˆé–‹ç™ºç’°å¢ƒå‘ã‘ï¼‰
- è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®å€¤ã¨ `JWT_SECRET` ã‚’æ–‡å­—åˆ—æ¯”è¼ƒ
- æœ¬æ ¼çš„ãª JWT ç½²åæ¤œè¨¼ãŒå¿…è¦ãªå ´åˆã¯ `src/web/middleware/auth.ts` ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„

### CORS

| ç’°å¢ƒ                           | è¨±å¯ã‚ªãƒªã‚¸ãƒ³                               |
| ------------------------------ | ------------------------------------------ |
| é–‹ç™ºï¼ˆ`NODE_ENV=development`ï¼‰ | ã™ã¹ã¦è¨±å¯                                 |
| æœ¬ç•ªï¼ˆ`NODE_ENV=production`ï¼‰  | `CORS_ORIGIN` ç’°å¢ƒå¤‰æ•°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æŒ‡å®š |

---

## ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ä¸€è¦§

ã™ã¹ã¦ `BaseError` ã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ã€‚

| ã‚¯ãƒ©ã‚¹               | statusCode | ç”¨é€”                     |
| -------------------- | ---------- | ------------------------ |
| `ValidationError`    | 400        | å…¥åŠ›å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— |
| `PermissionError`    | 403        | æ¨©é™ä¸è¶³                 |
| `NotFoundError`      | 404        | ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„   |
| `TimeoutError`       | 408        | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ             |
| `RateLimitError`     | 429        | ãƒ¬ãƒ¼ãƒˆåˆ¶é™               |
| `ConfigurationError` | 500        | è¨­å®šãƒŸã‚¹ï¼ˆç’°å¢ƒå¤‰æ•°ç­‰ï¼‰   |
| `DatabaseError`      | 500        | DB æ“ä½œå¤±æ•—              |
| `DiscordApiError`    | 500        | Discord API ã‚¨ãƒ©ãƒ¼       |

### `isOperational` ãƒ•ãƒ©ã‚°

`BaseError` ã¯ `isOperational: boolean` ã‚’æŒã¡ã¾ã™ã€‚

| å€¤                  | æ„å‘³                                       | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« |
| ------------------- | ------------------------------------------ | ---------- |
| `true` (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) | æƒ³å®šæ¸ˆã¿ã®é‹ç”¨ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒŸã‚¹ç­‰ï¼‰ | `warn`     |
| `false`             | ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãƒ»ãƒã‚°                 | `error`    |

`isOperational: false` ã®ã‚¨ãƒ©ãƒ¼ã¯ãƒã‚°ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è©³ç´°ã‚’è¿”ã—ã¾ã›ã‚“ã€‚

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©

`setupGlobalErrorHandlers()` ã‚’èµ·å‹•æ™‚ã«å‘¼ã³å‡ºã™ã¨ã€ä»¥ä¸‹ãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œã¾ã™ã€‚

```
process.on('unhandledRejection') â†’ ãƒ­ã‚°å‡ºåŠ›
process.on('uncaughtException')  â†’ ãƒ­ã‚°å‡ºåŠ› + process.exit(1)
process.on('warning')            â†’ ãƒ­ã‚°å‡ºåŠ›
```

`setupGracefulShutdown()` ã§ `SIGTERM` / `SIGINT` æ™‚ã« Prisma åˆ‡æ–­ + Botãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

---

## ğŸ§ª TEST_MODE ãƒ•ãƒ©ã‚°

`TEST_MODE=true` ã‚’è¨­å®šã™ã‚‹ã¨ã€Bump ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®å¾…æ©Ÿæ™‚é–“ãŒ **120åˆ† â†’ 1åˆ†** ã«çŸ­ç¸®ã•ã‚Œã¾ã™ã€‚
æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèªã‚„ E2E ãƒ†ã‚¹ãƒˆã«ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
# .env
TEST_MODE=true
```

```typescript
// src/bot/features/bump-reminder/constants/bumpReminderConstants.ts
export function getReminderDelayMinutes(): number {
  return env.TEST_MODE ? 1 : 120;
}
```

> **æ³¨æ„**: `TEST_MODE=true` ã¯æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [XSERVER_VPS_SETUP.md](XSERVER_VPS_SETUP.md) - VPS ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
- [DEPLOYMENT.md](DEPLOYMENT.md) - GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼
- [I18N_GUIDE.md](I18N_GUIDE.md) - å¤šè¨€èªå¯¾å¿œ
- [TESTING_GUIDELINES.md](TESTING_GUIDELINES.md) - ãƒ†ã‚¹ãƒˆæ–¹é‡
- [COMMANDS.md](COMMANDS.md) - ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- [../progress/IMPLEMENTATION_PROGRESS.md](../progress/IMPLEMENTATION_PROGRESS.md) - å®Ÿè£…é€²æ—
